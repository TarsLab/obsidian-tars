# MCP Integration Execution Tasks (Trimmed)

**Generated from:** `docs/2025-10-03-120627-tasks.md`, `docs/2025-10-03-115553-planning.md`
**Timestamp:** 2025-10-07-075907
**Purpose:** Track only unimplemented backlog items while keeping original structure and planning context.

---

## ðŸ“‹ Remaining Work Summary
- **Total Remaining Story Points**: 74 SP (per `docs/2025-10-03-120627-tasks.md`)
- **Epics In Scope**: Epic-500, Epic-600, Epic-700 (validation only), Epic-900
- **Blocking Dependencies**: Complete prior epics remain prerequisites (`Epic-100`â€“`Epic-400`)

---

## Epic-500: Advanced Features

**Priority**: P2 (elevated)
**Story Points**: 25
**Status**: Not Started
**Description**: Parallel execution, result caching, history UI, and associated validation.

### Feature-500-10: Parallel Tool Execution

**Priority**: P2 (elevated)
**Story Points**: 10
**Description**: Execute multiple tool calls concurrently with safety controls (`src/mcp/toolCallingCoordinator.ts`, `src/mcp/executor.ts`, `src/settingTab.ts`).

#### UserStory-500-10-5: Implement Parallel Execution

**Story Points**: 5
**Description**: Provide coordinator/executor changes for concurrent tool runs.

- [ ] **Task-500-10-5-1: Add parallel execution mode to coordinator**
  - **Files**: `src/mcp/toolCallingCoordinator.ts`
  - **Planning Notes**: Implement `options.parallelExecution` branch that gathers tool calls and resolves via `Promise.all()`.
  - **Acceptance Criteria**:
    - Given multiple tool calls, when `parallelExecution` is enabled, then coordinator issues concurrent executions and aggregates results without blocking sequential flow.

- [ ] **Task-500-10-5-2: Add execution synchronization**
  - **Files**: `src/mcp/executor.ts`
  - **Planning Notes**: Ensure thread-safe manipulation of `activeExecutions` plus enforcement of global concurrent limits.
  - **Acceptance Criteria**:
    - Given parallel executions, when tracking active sessions, then shared state remains consistent and respects `concurrentLimit`.

- [ ] **Task-500-10-5-3: Handle partial failures**
  - **Files**: `src/mcp/toolCallingCoordinator.ts`
  - **Planning Notes**: Catch per-tool errors, log via status bar, continue returning successes.
  - **Acceptance Criteria**:
    - Given one failure among parallel calls, when processing completes, then successful results are returned and failure is logged without aborting remaining work.

#### UserStory-500-10-10: Configuration & Safety

**Story Points**: 5
**Description**: Expose settings and tests that keep parallel mode controlled.

- [ ] **Task-500-10-10-1: Add parallelExecution setting**
  - **Files**: `src/settingTab.ts`
  - **Planning Notes**: Toggle default `false`, persists user preference.
  - **Acceptance Criteria**: Settings UI surfaces "Enable parallel tool execution" switch and saves the boolean flag.

- [ ] **Task-500-10-10-2: Add max parallel limit**
  - **Files**: `src/settingTab.ts`
  - **Planning Notes**: Numeric input bound to coordinator enforcement; defaults to existing `concurrentLimit`.
  - **Acceptance Criteria**: Execution never exceeds configured maximum even if more calls are requested.

- [ ] **Task-500-10-10-3: Add parallel execution tests**
  - **Files**: `tests/mcp/toolCallingCoordinator.test.ts`
  - **Planning Notes**: Cover success, partial failure, and limit enforcement scenarios.
  - **Acceptance Criteria**: Unit tests validate concurrency results and limit handling.

### Feature-500-20: Tool Result Caching

**Priority**: P3
**Story Points**: 8
**Description**: Cache tool outputs to avoid redundant executions (`src/mcp/resultCache.ts`, `src/mcp/executor.ts`, `src/settingTab.ts`).

#### UserStory-500-20-5: Implement Result Cache

**Story Points**: 5
**Description**: Introduce cache lifecycle.

- [ ] **Task-500-20-5-1: Create ResultCache class**
  - **Files**: `src/mcp/resultCache.ts`
  - **Planning Notes**: Implement hashing via SHA-256 over server ID, tool name, parameters.
  - **Acceptance Criteria**: Cache stores and retrieves deterministic entries keyed by parameter hash.

- [ ] **Task-500-20-5-2: Check cache before execution**
  - **Files**: `src/mcp/executor.ts`
  - **Planning Notes**: Short-circuit execution when cached response present; annotate response as cached.
  - **Acceptance Criteria**: Cached hits return without invoking tool server.

- [ ] **Task-500-20-5-3: Store results with TTL**
  - **Files**: `src/mcp/executor.ts`
  - **Planning Notes**: Default TTL 5 minutes; include timestamp metadata.
  - **Acceptance Criteria**: Successful executions populate cache with expiry logic honored on retrieval.

- [ ] **Task-500-20-5-4: Add cache invalidation**
  - **Files**: `src/mcp/resultCache.ts`
  - **Planning Notes**: Support TTL purge, manual clear, and server restart invalidation.
  - **Acceptance Criteria**: Stale entries removed automatically; manual/API invalidation clears targeted scopes.

#### UserStory-500-20-10: Cache UI Integration

**Story Points**: 3
**Description**: Surface cache state to users.

- [ ] **Task-500-20-10-1: Add cache indicator to results**
  - **Files**: `src/mcp/toolCallingCoordinator.ts`
  - **Planning Notes**: Annotate markdown with `ðŸ“¦ Cached (age)` metadata when applicable.
  - **Acceptance Criteria**: Documents clearly differentiate cached vs fresh outputs.

- [ ] **Task-500-20-10-2: Add cache management command**
  - **Files**: `src/main.ts`
  - **Planning Notes**: Register "Clear MCP Tool Result Cache" command invoking executor cache clear.
  - **Acceptance Criteria**: Command palette action purges cache and confirms via Notice.

- [ ] **Task-500-20-10-3: Add cache statistics**
  - **Files**: `src/modals/mcpStatusModal.ts`
  - **Planning Notes**: Display hit rate, size, entry count, oldest age.
  - **Acceptance Criteria**: Status modal exposes real-time cache metrics from executor.

### Feature-500-30: Execution History Viewer

**Priority**: P3
**Story Points**: 5
**Description**: Provide modal to inspect prior tool executions (`src/modals/executionHistoryModal.ts`, `src/main.ts`).

#### UserStory-500-30-5: Build History UI

**Story Points**: 5
**Description**: Create searchable execution history interface.

- [ ] **Task-500-30-5-1: Create ExecutionHistoryModal**
  - **Files**: `src/modals/executionHistoryModal.ts`
  - **Planning Notes**: Table with timestamp, server, tool, status, duration, actions.
  - **Acceptance Criteria**: Modal lists executions sorted by time.

- [ ] **Task-500-30-5-2: Add filters and search**
  - **Files**: `src/modals/executionHistoryModal.ts`
  - **Planning Notes**: Filters by server, tool, status, date range; real-time updates.
  - **Acceptance Criteria**: Filtering narrows results without refresh.

- [ ] **Task-500-30-5-3: Add detail view**
  - **Files**: `src/modals/executionHistoryModal.ts`
  - **Planning Notes**: Expand row details with parameters, result, metadata, errors.
  - **Acceptance Criteria**: Users can inspect full execution payload.

### Feature-500-90: Release Validation & Sign-Off

**Priority**: P3
**Story Points**: 2
**Description**: Manual approval for advanced features (`docs/release-notes.md`, `tests/manual/mcp-advanced-validation.md`).

#### UserStory-500-90-5: Human Review & Release Approval

- [ ] **Task-500-90-5-1: Run advanced feature validation script and document approval**
  - **Planning Notes**: Execute manual script covering parallel execution, caching, history viewer; capture evidence in release notes.
  - **Acceptance Criteria**: Release documentation includes reviewer sign-off and artifacts.

---

## Epic-600: Testing Infrastructure

**Priority**: P3
**Story Points**: 15
**Status**: Not Started
**Description**: Strengthen UI/unit/E2E coverage and tooling.

### Feature-600-10: UI Testing Strategy

**Priority**: P3
**Story Points**: 8
**Description**: Make UI logic testable without full Obsidian runtime (`src/statusBarManager.ts`, `src/modals/mcpStatusModal.ts`, `tests/ui/`).

#### UserStory-600-10-5: Extract Testable UI Logic

**Story Points**: 5
**Description**: Refactor UI formatting into pure functions.

- [ ] **Task-600-10-5-1: Extract status formatting functions**
  - **Files**: `src/statusBarManager.ts`, `src/utils/statusFormatting.ts`
  - **Planning Notes**: Move status string builders into utility module for testing.
  - **Acceptance Criteria**: Formatting logic becomes pure functions with unit tests available.

- [ ] **Task-600-10-5-2: Extract HTML generation functions**
  - **Files**: `src/modals/mcpStatusModal.ts`, `src/utils/htmlBuilders.ts`
  - **Planning Notes**: Generate HTML strings separately from DOM manipulation.
  - **Acceptance Criteria**: Modal rendering consumes reusable builders enabling headless tests.

- [ ] **Task-600-10-5-3: Add unit tests for UI logic**
  - **Files**: `tests/ui/statusFormatting.test.ts`
  - **Planning Notes**: Cover formatting/HTML builders for varied scenarios.
  - **Acceptance Criteria**: Tests verify UI logic across edge cases (no servers, failures, etc.).

#### UserStory-600-10-10: Playwright E2E Setup

**Story Points**: 3
**Description**: Establish UI automation baseline.

- [ ] **Task-600-10-10-1: Install and configure Playwright**
  - **Files**: `package.json`, `playwright.config.ts`
  - **Planning Notes**: Add `@playwright/test`, configure custom protocol base URL.
  - **Acceptance Criteria**: Playwright test runner executes against Obsidian vault context.

- [ ] **Task-600-10-10-2: Create test vault setup script**
  - **Files**: `scripts/setup-test-vault.sh`
  - **Planning Notes**: Automate vault creation, plugin install, sample data seeding.
  - **Acceptance Criteria**: Script provisions vault ready for E2E tests.

- [ ] **Task-600-10-10-3: Write sample E2E test**
  - **Files**: `tests/e2e-ui/mcp-settings.spec.ts`
  - **Planning Notes**: Validate MCP settings UI visibility as smoke test.
  - **Acceptance Criteria**: Baseline Playwright test passes in CI.

### Feature-600-20: Coverage Improvements

**Priority**: P3
**Story Points**: 5
**Description**: Add missing scenario tests across suites.

#### UserStory-600-20-5: Missing Test Coverage

- [ ] **Task-600-20-5-1: Add timeout handling tests**
  - **Files**: `tests/mcp/executor.test.ts`
  - **Planning Notes**: Simulate timeout exceed, assert cleanup of `activeExecutions`.
  - **Acceptance Criteria**: Tests prove timeout errors are surfaced and resources cleaned.

- [ ] **Task-600-20-5-3: Add health check tests**
  - **Files**: `tests/mcp/managerMCPUse.test.ts`
  - **Planning Notes**: Validate periodic health state updates and persistence.
  - **Acceptance Criteria**: Health map accurately reflects server states across runs.

- [ ] **Task-600-20-5-4: Add error scenario tests**
  - **Files**: `tests/mcp/errorHandling.test.ts`
  - **Planning Notes**: Cover server start failure, tool errors, network timeouts, invalid parameters, disconnects.
  - **Acceptance Criteria**: Error paths are exhaustively tested with assertions on logging and recovery.

### Feature-600-90: Release Validation & Sign-Off

**Priority**: P3
**Story Points**: 2

#### UserStory-600-90-5: Human Review & Release Approval

- [ ] **Task-600-90-5-1: Verify test tooling updates and capture approval**
  - **Planning Notes**: Run UI, integration, and Playwright suites; document outcomes in release notes with reviewer initials.
  - **Acceptance Criteria**: Manual validation evidence stored in `docs/release-notes.md` and supporting manual test doc.

---

## Epic-700: Settings UI Improvements (Validation Pending)

**Priority**: P2
**Story Points**: 0 (validation only)
**Status**: Pending Sign-Off
**Description**: Functional work complete; remaining task is manual validation.

### Feature-700-90: Release Validation & Sign-Off

**Priority**: P2
**Story Points**: 0

#### UserStory-700-90-5: Human Review & Release Approval

- [ ] **Task-700-90-5-1: Manual UI testing for config toggle**
  - **Acceptance Criteria**: Manual walkthrough confirms config display toggle behavior and documents evidence.

- [ ] **Task-700-90-5-2: Verify settings persistence**
  - **Acceptance Criteria**: Persistence of settings changes verified and recorded.

- [ ] **Task-700-90-5-3: Document sign-off**
  - **Acceptance Criteria**: Release notes updated with reviewer approval for Epic-700.

---

## Epic-900: Document-Scoped Sessions & Enhanced UX

**Priority**: P1
**Story Points**: 31
**Status**: Not Started
**Description**: Document-aware session lifecycle, smart caching, enhanced settings/status UX.

### Feature-900-10: Document-Scoped Session Management

**Priority**: P1
**Story Points**: 8
**Description**: Track and reset session counts per document (`src/mcp/executor.ts`, `src/main.ts`).

#### UserStory-900-10-5: Per-Document Session Tracking

- [x] **Task-900-10-5-1: Add document-scoped session tracker**
  - **Files**: `src/mcp/executor.ts`
  - **Planning Notes**: Maintain `documentSessions` map with total count across all servers, reset logic, notifications.
  - **Acceptance Criteria**: Each document maintains independent totals; resets occur on document reopen with user notice.
  - **Status**: âœ… Completed 2025-10-09 â€” validated via `tests/integration/toolExecution.test.ts`, `tests/e2e/documentToolFlow.test.ts`, `npm run test`

- [x] **Task-900-10-5-2: Detect document switch and update context**
  - **Files**: `src/main.ts`, `src/mcp/documentSessionHandlers.ts`
  - **Planning Notes**: Hook `active-leaf-change` and `vault.delete` events to manage executor context.
  - **Acceptance Criteria**: Switching files updates executor context while preserving previous document state.
  - **Status**: âœ… Completed 2025-10-09 â€” enforced via `src/mcp/documentSessionHandlers.ts`, validated by `tests/integration/documentSessionHandlers.test.ts`, `npm run test`

- [x] **Task-900-10-5-3: Add session reset notification UI**
  - **Files**: `src/mcp/executor.ts`, `src/main.ts`
  - **Planning Notes**: Implement `Notice` prompting when limit reached and when counter resets on reopen.
  - **Acceptance Criteria**: User can continue or cancel on limit reached; reopen notice informs of reset.
  - **Status**: âœ… Completed 2025-10-09 â€” covered by `tests/integration/toolExecution.test.ts`, `npm run test`

- [ ] **Task-900-10-5-4: Add tests for document-scoped sessions**
  - **Files**: `tests/mcp/executor.test.ts`
  - **Planning Notes**: Validate per-document counts, resets, cleanup.
  - **Acceptance Criteria**: Automated tests cover scenarios from planning Q&A.

### Feature-900-20: Smart Tool Result Caching

**Priority**: P1
**Story Points**: 5
**Description**: Reuse results already embedded in document (`src/mcp/toolResultCache.ts`, `src/mcp/toolCallingCoordinator.ts`, `src/codeBlockProcessor.ts`).

#### UserStory-900-20-5: Detect Existing Tool Results

- [ ] **Task-900-20-5-1: Create tool result cache parser**
  - **Files**: `src/mcp/toolResultCache.ts`
  - **Planning Notes**: Parse markdown to locate prior tool results, hash parameters order-independently.
  - **Acceptance Criteria**: Matching block retrieved with location and metadata when parameters align ignoring order.

- [ ] **Task-900-20-5-2: Add re-execution confirmation UI**
  - **Files**: `src/mcp/toolCallingCoordinator.ts`
  - **Planning Notes**: Provide Notice with choices "Re-execute", "Use Cached", "Cancel" including age.
  - **Acceptance Criteria**: Manual triggers prompt user; default callouts emphasize cached reuse.

- [ ] **Task-900-20-5-3: Integrate cache detection in coordinator**
  - **Files**: `src/mcp/toolCallingCoordinator.ts`
  - **Planning Notes**: Check cache before execution; respect `options.promptForCache` for LLM vs manual flows.
  - **Acceptance Criteria**: LLM flows can auto-use cache; manual flows require user confirmation; cancellations abort gracefully.

### Feature-900-30: Collapsible Settings Sections

**Priority**: P2
**Story Points**: 5
**Description**: Persist expanded/collapsed state for settings (`src/settingTab.ts`, `src/settings.ts`, `styles.css`).

#### UserStory-900-30-5: Persistent Section State

- [ ] **Task-900-30-5-1: Add UI state to settings schema**
  - **Files**: `src/settings.ts`
  - **Planning Notes**: Add `uiState` with defaults for `mcpServersExpanded`, `systemMessageExpanded`.
  - **Acceptance Criteria**: Stored state defaults to collapsed and persists across sessions.

- [ ] **Task-900-30-5-2: Implement collapsible MCP Servers section**
  - **Files**: `src/settingTab.ts`
  - **Planning Notes**: Use `<details>/<summary>` wrapping existing content; persist toggles on every change.
  - **Acceptance Criteria**: Section collapses by default, remembers state even without content edits.

- [ ] **Task-900-30-5-3: Implement collapsible System Message section**
  - **Files**: `src/settingTab.ts`
  - **Planning Notes**: Mirror MCP section behavior with persistence.
  - **Acceptance Criteria**: System message collapsible and stateful as per planning requirement.

- [ ] **Task-900-30-5-4: Add CSS styling for collapsible sections**
  - **Files**: `styles.css`
  - **Planning Notes**: Custom arrow indicators, hover feedback, consistent spacing.
  - **Acceptance Criteria**: Visual affordances meet design notes; arrow rotates on expand.

### Feature-900-40: Enhanced Display Mode Toggle

**Priority**: P2
**Story Points**: 8
**Description**: Smart conversions between URL/JSON/Shell formats (`src/settingTab.ts`, `src/mcp/displayMode.ts`, `src/mcp/mcpUseAdapter.ts`).

#### UserStory-900-40-5: Smart Conversion Modes

- [ ] **Task-900-40-5-1: Create conversion capability detector**
  - **Files**: `src/mcp/displayMode.ts`
  - **Planning Notes**: Detect format, determine convertible targets, identify mcp-remote compatibility.
  - **Acceptance Criteria**: Capability object accurately reflects permissible conversions and flags.

- [ ] **Task-900-40-5-2: Update toggle UI with smart labels**
  - **Files**: `src/settingTab.ts`
  - **Planning Notes**: Button cycles among supported formats with contextual labels/tooltips.
  - **Acceptance Criteria**: Toggle only offers valid conversions and communicates options clearly.

- [ ] **Task-900-40-5-3: Add conversion validation tests**
  - **Files**: `tests/mcp/displayMode.test.ts`
  - **Planning Notes**: Cover URLâ†’Shell, mcp-remote JSONâ†’URL/Shell, stdio JSON restrictions, Shell-only scenarios.
  - **Acceptance Criteria**: Unit tests guard against invalid conversions.

### Feature-900-50: Enhanced Status Bar Modal

**Priority**: P1
**Story Points**: 3
**Description**: Display per-document session totals and improved refresh workflow (`src/statusBarManager.ts`, `src/modals/mcpStatusModal.ts`).

#### UserStory-900-50-5: Session Count Display & Server Refresh

- [ ] **Task-900-50-5-1: Add session count display to status modal**
  - **Files**: `src/statusBarManager.ts`
  - **Planning Notes**: Show "Document Sessions: X/Y" with warning thresholds based on planning Q&A.
  - **Acceptance Criteria**: UI reflects total sessions per document and warning/alert icons at 80% and 100%.

- [ ] **Task-900-50-5-2: Implement graceful server restart with UI feedback**
  - **Files**: `src/modals/mcpStatusModal.ts`, `styles.css`
  - **Planning Notes**: Multi-phase status indicator (Stopping â†’ Waiting â†’ Starting â†’ Complete), 500ms delay, graceful shutdown with fallback force kill, resets current document sessions only.
  - **Acceptance Criteria**: Refresh flow updates UI per phase, respects timing, resets per-document session count, and handles errors gracefully.

### Feature-900-60: Auto-Generate Tool Parameters

**Priority**: P2
**Story Points**: 3
**Description**: Standardize parameter placeholders on insert (`src/modals/toolBrowserModal.ts`, `src/suggests/mcpToolSuggestHelpers.ts`).

#### UserStory-900-60-5: Parameter Template Insertion

- [ ] **Task-900-60-5-1: Verify existing template generation**
  - **Files**: `src/modals/toolBrowserModal.ts`
  - **Planning Notes**: Ensure types map to placeholders: `""`, `0`, `false`, `[]`, `{}` with optional example comments.
  - **Acceptance Criteria**: Templates insert correct default values per planning Q10.

- [ ] **Task-900-60-5-2: Add cursor positioning after insert**
  - **Files**: `src/modals/toolBrowserModal.ts`
  - **Planning Notes**: Place caret at first required parameter value post-insert.
  - **Acceptance Criteria**: Editor cursor lands on first editable parameter automatically.

- [ ] **Task-900-60-5-3: Add test for parameter generation**
  - **Files**: `tests/mcp/toolBrowserModal.test.ts`
  - **Planning Notes**: Validate placeholder types, optional markers, cursor positioning.
  - **Acceptance Criteria**: Test suite confirms template correctness and cursor behavior.

### Feature-900-70: Unified Tool Result Formatting

**Priority**: P2
**Story Points**: 2
**Description**: Share formatter between LLM and manual executions (`src/mcp/toolResultFormatter.ts`, `src/mcp/toolCallingCoordinator.ts`, `src/codeBlockProcessor.ts`).

#### UserStory-900-70-5: Consistent Tool Result Format

- [ ] **Task-900-70-5-1: Extract shared formatting function**
  - **Files**: `src/mcp/toolResultFormatter.ts`
  - **Planning Notes**: Provide exported `formatToolResult()` with corrected "Duration: Xms, Type: Y" spacing and collapsible support.
  - **Acceptance Criteria**: Formatter outputs consistent markdown with optional collapsible sections.

- [ ] **Task-900-70-5-2: Update coordinator and processor to use shared formatter**
  - **Files**: `src/mcp/toolCallingCoordinator.ts`, `src/codeBlockProcessor.ts`
  - **Planning Notes**: Replace inline formatting usage with shared helper.
  - **Acceptance Criteria**: All tool result insertions share identical format across execution paths.

---

## ðŸŽ¯ Next Steps (Priority Order)
- **Epic-900 (P1, 31 SP)**: Implement document-scoped sessions and UX enhancements before enabling advanced features.
- **Epic-500 (P2, 25 SP)**: After Epic-900, focus on parallel execution and caching enhancements.
- **Epic-600 (P3, 15 SP)**: Establish UI/E2E testing foundations and coverage improvements.
- **Epic-700 Validation (P2)**: Obtain manual sign-off to fully close settings UI work.
