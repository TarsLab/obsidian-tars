# Improved MCP Integration Implementation Plan

**Created**: 2025-10-03  
**Based on**: [2025-10-03-mcp-integration-review.md](docs/2025-10-03-mcp-integration-review.md) and code investigation in `src/mcp/`  
**Status**: Ready for Implementation  
**Total Story Points**: Σ(18+32+28+25+25+15)=143 (increased by 14 points due to added tasks and adjusted estimates)  

---

## Review of Existing Plan and Suggested Improvements

### Overall Assessment
- **Strengths**: The existing plan follows a logical structure with Epics, Features, UserStories, and Tasks. It includes dependencies, risks, and some acceptance criteria. The numbering system allows for insertions, and the TDD approach is solid.
- **Weaknesses**: 
  - Estimates are optimistic for AI implementation (e.g., complex adapters like Claude estimated at 8 points but require more integration with Anthropic SDK, bumping to 10). Human review is "slow," so I've increased points to account for 3-5x review time.
  - Priorities: Some P1 items (e.g., Claude integration) are critical but underestimated in risk; I've been critical and elevated certain tasks. P3 items like parallel execution have high complexity and should be P2 for better UX sooner.
  - Missed Work Items: Based on code investigation (e.g., [`providerAdapters.ts`](src/mcp/providerAdapters.ts:1) shows no Claude adapter exists, confirming review), added tasks for SSE support (via mcp-remote bridge, as suggested in review), cancellation support (noted as TODO in [`executor.ts`](src/mcp/executor.ts:143)), and more comprehensive testing for new features.
  - Acceptance Criteria: Existing ones are good but sparse; I've added/expanded to <5 per task, using Given-When-Then format.
  - Estimates Based on Code: Investigated `src/mcp/` definitions; e.g., adding Claude adapter involves new class similar to [`OllamaProviderAdapter`](src/mcp/providerAdapters.ts:342) (113 lines), so estimate increased. Simple fixes like ID mismatch are quick (1 point), but with tests and review, adjusted up.
- **Changes Made**: 
  - Added missed epics/features (e.g., SSE support in Epic-200).
  - Adjusted points critically: +2-3 for tasks needing more testing/integration.
  - Reprioritized: Moved parallel execution to P2.
  - Appended details: More file/line references, dependencies.
  - Total points increased to reflect realism.

### Updated Planning Principles
- **Story Points Scale**: Adjusted for "AI" speed (fast iteration) vs. "slow" human review (e.g., 1 point: AI <=1h / Review <=4h; 5 points: AI <=8h / Review <=4d).
- **Priority Levels**: Critical review - demoted non-essentials, promoted UX blockers.
- **Definition of Done**: Added requirement for code investigation in tasks.

---

## Epic-100: Critical Bug Fixes (Production Blockers)

**Priority**: P0 (unchanged - true blockers)  
**Story Points**: Σ(3+3+3+3+3+3)=18 (+2 for added tests/review)  
**Status**: Not Started  
**Description**: Fix critical bugs preventing MCP functionality. Code investigation confirms issues in [`managerMCPUse.ts`](src/mcp/managerMCPUse.ts:88) and [`executor.ts`](src/mcp/executor.ts:31).  
**Dependencies**: None  
**Risk**: High  

### Feature-100-10: Fix Server Initialization

**Priority**: P0  
**Story Points**: 3 (unchanged)  
**Description**: Resolve ID/name mismatch. Code shows mismatch at [`mcpUseAdapter.ts`](src/mcp/mcpUseAdapter.ts:30) and [`managerMCPUse.ts`](src/mcp/managerMCPUse.ts:88).  

#### UserStory-100-10-5: ID/Name Mismatch Resolution

**Priority**: P0  
**Story Points**: 3  

##### Task-100-10-5-1: Update mcpUseAdapter to use config.id

**Story Points**: 1  
**Priority**: P0  
**Acceptance Criteria**:  
- Given: Server config with id and name.  
- When: Converting to MCP-use format.  
- Then: Uses config.id as key; test confirms no "not found" error.  

##### Task-100-10-5-2: Update managerMCPUse session creation

**Story Points**: 1  
**Priority**: P0  
**Acceptance Criteria**:  
- Given: Session creation with config.id.  
- When: Storing in sessions map.  
- Then: Key matches id; integration test starts server successfully.  

##### Task-100-10-5-3: Add unit tests for ID/name alignment

**Story Points**: 1  
**Priority**: P0  
**Acceptance Criteria**:  
- Given: Config with mismatched id/name.  
- When: Running tests.  
- Then: Sessions create without errors; covers 3 cases (matching, mismatched, name-only).  

### Feature-100-20: Enable Configuration Settings

**Priority**: P0  
**Story Points**: 3 (unchanged)  
**Description**: Wire settings to executor. Code in [`index.ts`](src/mcp/index.ts:77) hardcodes values.  

#### UserStory-100-20-5: Wire Timeout Settings

**Priority**: P0  
**Story Points**: 3  

##### Task-100-20-5-0: Add regression test for executor options

**Story Points**: 1  
**Priority**: P0  
**Acceptance Criteria**:  
- Given: Hardcoded defaults.  
- When: Testing options override.  
- Then: Fails initially, passes after fix.  

##### Task-100-20-5-1: Update createToolExecutor signature

**Story Points**: 1  
**Priority**: P0  
**Acceptance Criteria**:  
- Given: Factory call with options.  
- When: Creating executor.  
- Then: Tracker uses provided timeout/limits.  

##### Task-100-20-5-2: Thread settings from main.ts

**Story Points**: 1  
**Priority**: P0  
**Acceptance Criteria**:  
- Given: User settings loaded.  
- When: Initializing in main.ts.  
- Then: Passes settings to factory; test verifies values.  

### Feature-100-30: Activate Health Monitoring

**Priority**: P0  
**Story Points**: 3 (unchanged)  
**Description**: Start timer. Code defines interval in [`index.ts`](src/mcp/index.ts) but no setInterval.  

#### UserStory-100-30-5: Start Health Check Timer

**Priority**: P0  
**Story Points**: 3  

##### Task-100-30-5-0: Write timer orchestration test

**Story Points**: 1  
**Priority**: P0  
**Acceptance Criteria**:  
- Given: Mocked timer.  
- When: Loading/unloading plugin.  
- Then: Interval scheduled/cleared.  

##### Task-100-30-5-1: Add setInterval in main.ts onload

**Story Points**: 1  
**Priority**: P0  
**Acceptance Criteria**:  
- Given: MCP manager initialized.  
- When: Plugin loads.  
- Then: Checks run every 30s; test mocks interval.  

##### Task-100-30-5-2: Clear timer in onunload

**Story Points**: 1  
**Priority**: P0  
**Acceptance Criteria**:  
- Given: Active timer.  
- When: Unloading.  
- Then: clearInterval called; no leaks.  

### Feature-100-40: Fix Inefficient Tool Discovery (Missed in original, added)

**Priority**: P0 (elevated - performance blocker per review)  
**Story Points**: 3  
**Description**: Cache mappings. Code in [`providerAdapters.ts`](src/mcp/providerAdapters.ts:254) calls async repeatedly.  

#### UserStory-100-40-5: Implement Tool Mapping Cache

**Priority**: P0  
**Story Points**: 3  

##### Task-100-40-5-1: Add cache storage to provider adapters

**Story Points**: 1  
**Priority**: P0  
**Acceptance Criteria**:  
- Given: Adapter initialize.  
- When: Caching mapping.  
- Then: Stores and timestamps cache.  

##### Task-100-40-5-2: Use cached mapping in buildTools

**Story Points**: 1  
**Priority**: P0  
**Acceptance Criteria**:  
- Given: Valid cache.  
- When: Building tools.  
- Then: Uses cache, no async call.  

##### Task-100-40-5-3: Invalidate cache on server changes

**Story Points**: 1  
**Priority**: P0  
**Acceptance Criteria**:  
- Given: Server event.  
- When: Invalidating.  
- Then: Cache cleared; next build refreshes.  

### Feature-100-50: Fix Memory Leaks

**Priority**: P0  
**Story Points**: 3 (+1 for added test)  
**Description**: Cleanup errors. Code in [`executor.ts`](src/mcp/executor.ts:31) misses some paths.  

#### UserStory-100-50-5: Fix Execution Cleanup

**Priority**: P0  
**Story Points**: 3  

##### Task-100-50-5-1: Audit error paths in executor

**Story Points**: 1  
**Priority**: P0  
**Acceptance Criteria**:  
- Given: Executor methods.  
- When: Auditing.  
- Then: All paths documented; fixes identified.  

##### Task-100-50-5-2: Add cleanup to error handlers

**Story Points**: 1  
**Priority**: P0  
**Acceptance Criteria**:  
- Given: Error in executeTool.  
- When: Handling exception.  
- Then: Cleanup in finally; test confirms no leak.  

##### Task-100-50-5-3: Add memory leak detection tests (Added)

**Story Points**: 1  
**Priority**: P0  
**Acceptance Criteria**:  
- Given: 100 failed executions.  
- When: Checking activeExecutions.  
- Then: Size remains 0; no growth.  

### Feature-100-90: Release Validation & Sign-Off

**Priority**: P0  
**Story Points**: 3 (+1 for expanded validation)  
**Description**: Manual checks.  

#### UserStory-100-90-5: Human Review & Release Approval

**Priority**: P0  
**Story Points**: 3  

##### Task-100-90-5-1: Conduct manual verification and document sign-off

**Story Points**: 3  
**Priority**: P0  
**Acceptance Criteria**:  
- Given: Fixes merged.  
- When: Running smoke tests.  
- Then: Notes include screenshots, logs, sign-off.  
- And: Covers new features like caching.  

---

## Epic-200: Core Missing Features

**Priority**: P1 (unchanged)  
**Story Points**: Σ(10+10+8+2+2)=32 (+4 for SSE and tests)  
**Status**: Not Started  
**Description**: Implement missing core features. Code confirms no Claude adapter in [`providerAdapters.ts`](src/mcp/providerAdapters.ts:1).  
**Dependencies**: Epic-100  
**Risk**: Medium  

### Feature-200-10: Auto-Disable Failed Servers

**Priority**: P1  
**Story Points**: 10 (unchanged)  

#### UserStory-200-10-5: Implement Failure Tracking

**Priority**: P1  
**Story Points**: 5  

##### Task-200-10-5-0: Add failure counter regression test

**Story Points**: 1  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: startServer failure.  
- When: Testing counter.  
- Then: Increments/resets correctly.  

##### Task-200-10-5-1: Add failureCount to server config

**Story Points**: 1  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: New config.  
- When: Creating server.  
- Then: failureCount defaults to 0.  

##### Task-200-10-5-2: Increment on startServer failure

**Story Points**: 1  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: Failed start.  
- When: Catching error.  
- Then: failureCount +1.  

##### Task-200-10-5-3: Reset on successful start

**Story Points**: 2 (+1 for test)  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: failureCount >0.  
- When: Successful start.  
- Then: Resets to 0; test confirms.  

#### UserStory-200-10-10: Auto-Disable Logic

**Priority**: P1  
**Story Points**: 5  

##### Task-200-10-10-1: Check threshold and disable

**Story Points**: 1  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: failureCount >=3.  
- When: Another failure.  
- Then: enabled=false, autoDisabled=true.  

##### Task-200-10-10-2: Emit server-auto-disabled event

**Story Points**: 1  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: Auto-disable triggered.  
- When: Emitting event.  
- Then: UI updates status.  

##### Task-200-10-10-3: Validate auto-disable flow via Playwright

**Story Points**: 3 (+1 for expanded E2E)  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: Mock failing server.  
- When: Simulating failures.  
- Then: UI shows auto-disabled; re-enable works.  

### Feature-200-20: Claude Provider Integration

**Priority**: P1  
**Story Points**: 10 (+2 for complexity per code review)  

#### UserStory-200-20-5: Create Claude Provider Adapter

**Priority**: P1  
**Story Points**: 6 (+1)  

##### Task-200-20-5-1: Create ClaudeProviderAdapter class

**Story Points**: 2  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: ProviderAdapter interface.  
- When: Implementing class.  
- Then: All methods match Claude API.  

##### Task-200-20-5-2: Implement buildTools for Claude format

**Story Points**: 1  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: MCP tools.  
- When: Building for Claude.  
- Then: Uses input_schema.  

##### Task-200-20-5-3: Implement formatToolResult for Claude

**Story Points**: 1  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: Tool result.  
- When: Formatting.  
- Then: Returns tool_result message.  

##### Task-200-20-5-4: Add ClaudeToolResponseParser

**Story Points**: 2 (+1 for streaming complexity)  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: Streaming events.  
- When: Parsing.  
- Then: Extracts tool_use blocks correctly.  

#### UserStory-200-20-10: Integrate into Claude Provider

**Priority**: P1  
**Story Points**: 4 (+1)  

##### Task-200-20-10-1: Update sendRequestFunc signature

**Story Points**: 1  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: sendRequestFunc.  
- When: Adding params.  
- Then: Accepts mcpManager/executor.  

##### Task-200-20-10-2: Route through ToolCallingCoordinator

**Story Points**: 1  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: MCP available.  
- When: Streaming response.  
- Then: Uses coordinator for tools.  

##### Task-200-20-10-3: Add unit tests for Claude adapter

**Story Points**: 2 (+1)  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: Mock events.  
- When: Running tests.  
- Then: Covers init, parse, format, multi-turn.  

### Feature-200-30: Tool Result Persistence

**Priority**: P0 (elevated - critical for transparency per review)  
**Story Points**: 8 (unchanged)  

#### UserStory-200-30-5: Persist Tool Calls in Documents

**Priority**: P1  
**Story Points**: 8  

##### Task-200-30-5-0: Add integration test for markdown persistence

**Story Points**: 1  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: Coordinator without persistence.  
- When: Testing buffer insert.  
- Then: Fails initially, passes after.  

##### Task-200-30-5-1: Modify ToolCallingCoordinator to accept editor

**Story Points**: 1  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: generateWithTools.  
- When: Adding editor option.  
- Then: Editor available for inserts.  

##### Task-200-30-5-2: Insert tool call markdown format

**Story Points**: 2  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: Tool to execute.  
- When: Inserting markdown.  
- Then: Shows name/parameters in code block.  

##### Task-200-30-5-3: Insert tool result markdown

**Story Points**: 2  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: Completed execution.  
- When: Inserting result.  
- Then: Collapsible JSON with duration.  

#### UserStory-200-30-10: Format Tool Results

**Priority**: P1  
**Story Points**: 8 (moved from original, unchanged)  

##### Task-200-30-10-1: Design result markdown template

**Story Points**: 1  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: Tool result.  
- When: Formatting.  
- Then: Uses <details> for collapse.  

##### Task-200-30-10-2: Handle different content types

**Story Points**: 1  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: JSON/text/markdown result.  
- When: Rendering.  
- Then: Appropriate syntax used.  

##### Task-200-30-10-3: Add metadata display

**Story Points**: 1  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: Result with metadata.  
- When: Displaying.  
- Then: Shows duration/type/tokens.  

### Feature-200-40: SSE Support via mcp-remote (Added - missed in original)

**Priority**: P1 (critical for remote servers per review)  
**Story Points**: 2  
**Description**: Add SSE support using mcp-remote bridge. Review suggests this; code in [`config.ts`](src/mcp/config.ts:47) supports URLs but throws errors.  

#### UserStory-200-40-5: Integrate mcp-remote Bridge

**Priority**: P1  
**Story Points**: 2  

##### Task-200-40-5-1: Modify toMCPUseFormat for URLs

**Story Points**: 1  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: URL config.  
- When: Converting.  
- Then: Uses 'npx mcp-remote <url>'.  

##### Task-200-40-5-2: Remove URL validation error

**Story Points**: 1  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: URL input.  
- When: Validating.  
- Then: No error; treats as valid.  

### Feature-200-90: Release Validation & Sign-Off

**Priority**: P1  
**Story Points**: 2 (unchanged)  

#### UserStory-200-90-5: Human Review & Release Approval

**Priority**: P1  
**Story Points**: 2  

##### Task-200-90-5-1: Execute manual validation checklist and collect approvals

**Story Points**: 2  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: Core features implemented.  
- When: Validating.  
- Then: Notes include evidence/sign-off for Claude/SSE/persistence.  

---

## Epic-300: Performance & Resource Management

**Priority**: P1 (unchanged)  
**Story Points**: Σ(5+3+8+10+2)=28 (+2 for added backoff tests)  
**Status**: Not Started  
**Description**: Optimize. Code in [`executor.ts`](src/mcp/executor.ts:19) shows leak risks.  
**Dependencies**: Epic-100, Epic-200  
**Risk**: Medium  

### Feature-300-10: Tool Discovery Caching

**Priority**: P1  
**Story Points**: 5 (unchanged)  

#### UserStory-300-10-5: Cache Tool Server Mappings

**Priority**: P2  
**Story Points**: 3  

##### Task-300-10-5-1: Add cache Map to provider adapters

**Story Points**: 1  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: Adapter init.  
- When: Caching.  
- Then: Map stored/reused.  

##### Task-300-10-5-2: Invalidate cache on server changes

**Story Points**: 1  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: Server event.  
- When: Invalidating.  
- Then: Cache cleared.  

##### Task-300-10-5-3: Add cache metrics

**Story Points**: 1  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: Cache usage.  
- When: Logging.  
- Then: Shows hit/miss ratio.  

#### UserStory-300-10-10: Optimize Tool Listing

**Priority**: P2  
**Story Points**: 2  

##### Task-300-10-10-1: Batch tool listing requests

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Multiple adapters.  
- When: Building mappings.  
- Then: Single call shared.  

##### Task-300-10-10-2: Add lazy initialization option

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Adapter created.  
- When: No immediate use.  
- Then: Defers discovery.  

### Feature-300-20: Memory Leak Prevention

**Priority**: P1  
**Story Points**: 3 (unchanged)  

#### UserStory-300-20-5: Fix Execution Cleanup

**Priority**: P1  
**Story Points**: 3  

##### Task-300-20-5-1: Audit error paths in executor

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Executor methods.  
- When: Auditing.  
- Then: Paths documented.  

##### Task-300-20-5-2: Add cleanup to error handlers

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Error path.  
- When: Handling.  
- Then: Cleanup executed.  

##### Task-300-20-5-3: Add memory leak detection tests

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Failed executions.  
- When: Checking size.  
- Then: No unbounded growth.  

### Feature-300-30: Error Recovery Mechanism

**Priority**: P1  
**Story Points**: 8 (unchanged)  

#### UserStory-300-30-5: Exponential Backoff Retry

**Priority**: P1  
**Story Points**: 8  

##### Task-300-30-5-1: Add RetryPolicy configuration

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Config.  
- When: Setting policy.  
- Then: Defaults applied.  

##### Task-300-30-5-2: Implement exponential backoff

**Story Points**: 2  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Failed start.  
- When: Retrying.  
- Then: Delays increase exponentially.  

##### Task-300-30-5-3: Classify transient vs permanent errors

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Error type.  
- When: Classifying.  
- Then: Transients retry, permanents don't.  

##### Task-300-30-5-4: Add retry status to UI

**Story Points**: 1  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: Retry in progress.  
- When: Viewing UI.  
- Then: Shows attempt/delay.  

##### Task-300-30-5-5: Add retry/backoff unit tests

**Story Points**: 3 (+1 for more cases)  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: Retry policy.  
- When: Testing backoff.  
- Then: Covers transient/permanent, caps delay.  

### Feature-300-40: Cancellation Support (Added - TODO in code)

**Priority**: P1 (elevated - review notes as missing)  
**Story Points**: 10  
**Description**: Implement true cancellation. Code has TODO in [`executor.ts`](src/mcp/executor.ts:143).  

#### UserStory-300-40-5: Add Abort Support

**Priority**: P1  
**Story Points**: 10  

##### Task-300-40-5-1: Add AbortController to executeTool

**Story Points**: 2  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: Execution request.  
- When: Adding signal.  
- Then: Passes to client.callTool.  

##### Task-300-40-5-2: Implement cancelExecution with abort

**Story Points**: 2  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: Active execution.  
- When: Cancelling.  
- Then: Aborts underlying call; cleans up.  

##### Task-300-40-5-3: Add UI cancel button

**Story Points**: 2  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: Pending execution.  
- When: Clicking cancel.  
- Then: Stops and shows message.  

##### Task-300-40-5-4: Test cancellation flows

**Story Points**: 4  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: Long-running tool.  
- When: Cancelling mid-execution.  
- Then: Aborts cleanly; no leaks.  

### Feature-300-90: Release Validation & Sign-Off

**Priority**: P1  
**Story Points**: 2 (unchanged)  

#### UserStory-300-90-5: Human Review & Release Approval

**Priority**: P1  
**Story Points**: 2  

##### Task-300-90-5-1: Execute manual resilience checklist and record approval

**Story Points**: 2  
**Priority**: P1  
**Acceptance Criteria**:  
- Given: Features merged.  
- When: Validating.  
- Then: Notes cover caching/backoff/cancellation.  

---

## Epic-400: User Experience Enhancements

**Priority**: P2 (unchanged)  
**Story Points**: Σ(8+8+5+2+2)=25 (+2 for added auto-complete tests)  
**Status**: Not Started  
**Description**: Improve UX.  
**Dependencies**: Epic-100, Epic-200  
**Risk**: Low  

### Feature-400-10: Tool Browser Modal

**Priority**: P2  
**Story Points**: 8 (unchanged)  

#### UserStory-400-10-5: Create Tool Browser UI

**Priority**: P2  
**Story Points**: 3  

##### Task-400-10-5-1: Create ToolBrowserModal class

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Modal extension.  
- When: Opening.  
- Then: Lists servers/tools.  

##### Task-400-10-5-2: Add server filter dropdown

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Multiple servers.  
- When: Selecting.  
- Then: Filters tools.  

##### Task-400-10-5-3: Render tool cards

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Tool data.  
- When: Rendering.  
- Then: Shows name/description/parameters.  

### Feature-400-20: Tool Auto-Completion

**Priority**: P2  
**Story Points**: 8 (unchanged)  

#### UserStory-400-20-5: Tool Name Auto-Complete

**Priority**: P2  
**Story Points**: 3  

##### Task-400-20-5-1: Create MCPToolSuggest class

**Story Points**: 2  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Typing 'tool:'.  
- When: Triggering suggest.  
- Then: Shows tool names.  

##### Task-400-20-5-2: Detect code block context

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Code fence.  
- When: Detecting.  
- Then: Filters by server.  

#### UserStory-400-20-10: Parameter Auto-Complete

**Priority**: P2  
**Story Points**: 5 (+2 for tests)  

##### Task-400-20-10-1: Create MCPParameterSuggest class

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Parameter line.  
- When: Triggering.  
- Then: Suggests params.  

##### Task-400-20-10-2: Parse parameter schema

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Tool schema.  
- When: Extracting.  
- Then: Returns name/type/required.  

##### Task-400-20-10-3: Show parameter metadata

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Suggestions.  
- When: Rendering.  
- Then: Shows type/required.  

##### Task-400-20-10-4: Add auto-complete tests (Added)

**Story Points**: 2  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Mock editor.  
- When: Testing suggest.  
- Then: Covers name/parameter flows.  

### Feature-400-30: Enhanced Status Display

**Priority**: P2  
**Story Points**: 5 (unchanged)  

#### UserStory-400-30-5: Real-Time Status Updates

**Priority**: P2  
**Story Points**: 3  

##### Task-400-30-5-1: Listen to manager events

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Event emitted.  
- When: Listening.  
- Then: Status updates immediately.  

##### Task-400-30-5-2: Add execution count to status

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Active executions.  
- When: Viewing bar.  
- Then: Shows count.  

##### Task-400-30-5-3: Add error indicators

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Error state.  
- When: Viewing.  
- Then: Shows icon/count.  

#### UserStory-400-30-10: Enhanced Status Modal

**Priority**: P2  
**Story Points**: 2  

##### Task-400-30-10-1: Add execution statistics

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Modal open.  
- When: Viewing details.  
- Then: Shows avg duration/success rate.  

##### Task-400-30-10-2: Add refresh button

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Modal open.  
- When: Refreshing.  
- Then: Re-queries and updates.  

### Feature-400-40: Templated Inserts (Added - improves UX)

**Priority**: P2  
**Story Points**: 2  
**Description**: Add command for inserting tool templates.  

#### UserStory-400-40-5: Implement Templated Insert Command

**Priority**: P2  
**Story Points**: 2  

##### Task-400-40-5-1: Add "Insert MCP Tool Call" command

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Command palette.  
- When: Selecting.  
- Then: Picks tool, inserts template.  

##### Task-400-40-5-2: Generate parameter placeholders

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Tool schema.  
- When: Generating.  
- Then: Includes all params with examples.  

### Feature-400-90: Release Validation & Sign-Off

**Priority**: P2  
**Story Points**: 2 (unchanged)  

#### UserStory-400-90-5: Human Review & Release Approval

**Priority**: P2  
**Story Points**: 2  

##### Task-400-90-5-1: Run UX smoke test script and record feedback

**Story Points**: 2  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: UX features.  
- When: Testing.  
- Then: Notes include screenshots/feedback.  

---

## Epic-500: Advanced Features

**Priority**: P2 (elevated - parallel is important for UX)  
**Story Points**: Σ(10+8+5+2)=25 (+2 for tests)  
**Status**: Not Started  
**Description**: Advanced features.  
**Dependencies**: Epic-100-400  
**Risk**: Low  

### Feature-500-10: Parallel Tool Execution

**Priority**: P2 (elevated)  
**Story Points**: 10 (+2)  

#### UserStory-500-10-5: Implement Parallel Execution

**Priority**: P2  
**Story Points**: 5  

##### Task-500-10-5-1: Add parallel execution mode to coordinator

**Story Points**: 2  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Multiple calls.  
- When: Parallel enabled.  
- Then: Uses Promise.all.  

##### Task-500-10-5-2: Add execution synchronization

**Story Points**: 2  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Parallel exec.  
- When: Tracking.  
- Then: Synchronizes set updates.  

##### Task-500-10-5-3: Handle partial failures

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Partial failure.  
- When: Executing.  
- Then: Continues with successes.  

#### UserStory-500-10-10: Configuration & Safety

**Priority**: P2  
**Story Points**: 5  

##### Task-500-10-10-1: Add parallelExecution setting

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Settings.  
- When: Toggling.  
- Then: Defaults false.  

##### Task-500-10-10-2: Add max parallel limit

**Story Points**: 1  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Many tools.  
- When: Executing.  
- Then: Enforces limit.  

##### Task-500-10-10-3: Add parallel execution tests

**Story Points**: 3 (+2)  
**Priority**: P2  
**Acceptance Criteria**:  
- Given: Multiple tools.  
- When: Testing parallel.  
- Then: Covers failures/limits.  

### Feature-500-20: Tool Result Caching

**Priority**: P3  
**Story Points**: 8 (unchanged)  

#### UserStory-500-20-5: Implement Result Cache

**Priority**: P3  
**Story Points**: 5 (+1 for TTL tests)  

##### Task-500-20-5-1: Create ResultCache class

**Story Points**: 2  
**Priority**: P3  
**Acceptance Criteria**:  
- Given: Request.  
- When: Hashing.  
- Then: Stable hash generated.  

##### Task-500-20-5-2: Check cache before execution

**Story Points**: 1  
**Priority**: P3  
**Acceptance Criteria**:  
- Given: Cached result.  
- When: Executing.  
- Then: Returns cached.  

##### Task-500-20-5-3: Store results with TTL

**Story Points**: 1  
**Priority**: P3  
**Acceptance Criteria**:  
- Given: Successful exec.  
- When: Storing.  
- Then: Includes TTL.  

##### Task-500-20-5-4: Add cache invalidation

**Story Points**: 1  
**Priority**: P3  
**Acceptance Criteria**:  
- Given: Expired cache.  
- When: Checking.  
- Then: Not returned.  

#### UserStory-500-20-10: Cache UI Integration

**Priority**: P3  
**Story Points**: 3  

##### Task-500-20-10-1: Add cache indicator to results

**Story Points**: 1  
**Priority**: P3  
**Acceptance Criteria**:  
- Given: Cached result.  
- When: Displaying.  
- Then: Shows "Cached" with age.  

##### Task-500-20-10-2: Add cache management command

**Story Points**: 1  
**Priority**: P3  
**Acceptance Criteria**:  
- Given: Command.  
- When: Clearing.  
- Then: Cache emptied.  

##### Task-500-20-10-3: Add cache statistics

**Story Points**: 1  
**Priority**: P3  
**Acceptance Criteria**:  
- Given: Modal.  
- When: Viewing.  
- Then: Shows hit rate/size.  

### Feature-500-30: Execution History Viewer

**Priority**: P3  
**Story Points**: 5 (unchanged)  

#### UserStory-500-30-5: Build History UI

**Priority**: P3  
**Story Points**: 5  

##### Task-500-30-5-1: Create ExecutionHistoryModal

**Story Points**: 2  
**Priority**: P3  
**Acceptance Criteria**:  
- Given: History data.  
- When: Opening.  
- Then: Shows sorted table.  

##### Task-500-30-5-2: Add filters and search

**Story Points**: 2  
**Priority**: P3  
**Acceptance Criteria**:  
- Given: Filters.  
- When: Applying.  
- Then: Table updates.  

##### Task-500-30-5-3: Add detail view

**Story Points**: 1  
**Priority**: P3  
**Acceptance Criteria**:  
- Given: Execution entry.  
- When: Viewing details.  
- Then: Shows params/result/error.  

### Feature-500-90: Release Validation & Sign-Off

**Priority**: P3  
**Story Points**: 2 (unchanged)  

#### UserStory-500-90-5: Human Review & Release Approval

**Priority**: P3  
**Story Points**: 2  

##### Task-500-90-5-1: Run advanced feature validation script and document approval

**Story Points**: 2  
**Priority**: P3  
**Acceptance Criteria**:  
- Given: Advanced features.  
- When: Validating.  
- Then: Notes include evidence/approval.  

---

## Epic-600: Testing Infrastructure

**Priority**: P3 (unchanged)  
**Story Points**: Σ(8+5+2)=15 (+2 for more coverage)  
**Status**: Not Started  
**Description**: Improve testing.  
**Dependencies**: Epic-100, Epic-200  
**Risk**: Low  

### Feature-600-10: UI Testing Strategy

**Priority**: P3  
**Story Points**: 8 (unchanged)  

#### UserStory-600-10-5: Extract Testable UI Logic

**Priority**: P3  
**Story Points**: 5  

##### Task-600-10-5-1: Extract status formatting functions

**Story Points**: 1  
**Priority**: P3  
**Acceptance Criteria**:  
- Given: Status logic.  
- When: Extracting.  
- Then: Pure functions testable.  

##### Task-600-10-5-2: Extract HTML generation functions

**Story Points**: 2  
**Priority**: P3  
**Acceptance Criteria**:  
- Given: Modal content.  
- When: Building HTML.  
- Then: Returns testable string.  

##### Task-600-10-5-3: Add unit tests for UI logic

**Story Points**: 2  
**Priority**: P3  
**Acceptance Criteria**:  
- Given: Functions.  
- When: Testing.  
- Then: Covers edge cases.  

#### UserStory-600-10-10: Playwright E2E Setup

**Priority**: P3  
**Story Points**: 3  

##### Task-600-10-10-1: Install and configure Playwright

**Story Points**: 1  
**Priority**: P3  
**Acceptance Criteria**:  
- Given: Dependencies.  
- When: Installing.  
- Then: Configured for Obsidian.  

##### Task-600-10-10-2: Create test vault setup script

**Story Points**: 1  
**Priority**: P3  
**Acceptance Criteria**:  
- Given: Build output.  
- When: Running script.  
- Then: Vault ready with plugin.  

##### Task-600-10-10-3: Write sample E2E test

**Story Points**: 1  
**Priority**: P3  
**Acceptance Criteria**:  
- Given: Playwright test.  
- When: Running.  
- Then: Verifies UI elements.  

### Feature-600-20: Coverage Improvements

**Priority**: P3  
**Story Points**: 5 (+2)  

#### UserStory-600-20-5: Missing Test Coverage

**Priority**: P3  
**Story Points**: 5  

##### Task-600-20-5-1: Add timeout handling tests

**Story Points**: 1  
**Priority**: P3  
**Acceptance Criteria**:  
- Given: Exceeded timeout.  
- When: Executing.  
- Then: Error thrown, cleaned up.  

##### Task-600-20-5-3: Add health check tests

**Story Points**: 1  
**Priority**: P3  
**Acceptance Criteria**:  
- Given: Timer running.  
- When: Checking health.  
- Then: Status updated.  

##### Task-600-20-5-4: Add error scenario tests

**Story Points**: 1  
**Priority**: P3  
**Acceptance Criteria**:  
- Given: Error conditions.  
- When: Testing.  
- Then: Handled correctly.  

##### Task-600-20-5-5: Add SSE support tests (Added)

**Story Points**: 2  
**Priority**: P3  
**Acceptance Criteria**:  
- Given: URL config.  
- When: Starting server.  
- Then: Bridge used; test passes.  

### Feature-600-90: Release Validation & Sign-Off

**Priority**: P3  
**Story Points**: 2 (unchanged)  

#### UserStory-600-90-5: Human Review & Release Approval

**Priority**: P3  
**Story Points**: 2  

##### Task-600-90-5-1: Verify test tooling updates and capture approval

**Story Points**: 2  
**Priority**: P3  
**Acceptance Criteria**:  
- Given: Tooling changes.  
- When: Verifying.  
- Then: Notes include outcomes/approval.  

---

## Updated Summary & Timeline

**Total Story Points**: 143 (+14)  
**Estimated Timeline**: 7-9 weeks (adjusted for realism).  
**Phases**: Extended Phase 2/3 for added items; otherwise similar.  
**Final Notes**: This improved plan is more comprehensive, with better estimates based on code, added items (SSE, cancellation), and complete acceptance criteria. Implement in order.
